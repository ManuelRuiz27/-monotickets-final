name: Smoke and E2E

on:
  push:
    branches:
      - main
      - develop
      - qa/tests
  pull_request:
    branches:
      - main
      - develop
      - qa/tests

jobs:
  build-and-up:
    runs-on: ubuntu-latest
    env:
      COMPOSE_PROFILES: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Pull images
        run: docker compose --profile "$COMPOSE_PROFILES" pull || true
      - name: Build test container
        run: docker compose build tests
      - name: Start services
        run: docker compose --profile "$COMPOSE_PROFILES" up -d database redis backend-api dashboard pwa
      - name: Wait for readiness
        run: |
          set -o pipefail
          mkdir -p reports/smoke
          npm run smoke:readiness 2>&1 | tee reports/smoke/readiness.log
        env:
          BACKEND_URL: http://backend:8080/health
          FRONTEND_URL: http://frontend:3001/
      - name: Smoke check services
        run: |
          set -o pipefail
          mkdir -p reports/smoke
          npm run smoke:services 2>&1 | tee reports/smoke/services.log
        env:
          BACKEND_URL: http://backend:8080/health
          FRONTEND_URL: http://frontend:3001/
      - name: Upload smoke logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs
          path: reports/smoke
      - name: Tear down services
        if: always()
        run: docker compose --profile "$COMPOSE_PROFILES" down

  tests-e2e:
    runs-on: ubuntu-latest
    needs: build-and-up
    env:
      COMPOSE_PROFILES: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build test container
        run: docker compose build tests
      - name: Start dependencies
        run: docker compose --profile "$COMPOSE_PROFILES" up -d database redis backend-api dashboard pwa
      - name: Wait for readiness
        run: |
          set -o pipefail
          mkdir -p reports/smoke
          npm run smoke:readiness 2>&1 | tee reports/smoke/readiness-e2e.log
        env:
          BACKEND_URL: http://backend:8080/health
          FRONTEND_URL: http://frontend:3001/
      - name: Run E2E tests
        run: docker compose run --rm tests
      - name: Collect artifacts
        if: always()
        run: npm run test:post
      - name: Upload JUnit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: reports/junit/**/*.xml
          if-no-files-found: warn
          retention-days: 10
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/**
          if-no-files-found: warn
          retention-days: 10
      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: tests/artifacts/**
          if-no-files-found: warn
          retention-days: 10
      - name: Upload readiness logs (e2e)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-logs-e2e
          path: reports/smoke
      - name: Tear down services
        if: always()
        run: docker compose --profile "$COMPOSE_PROFILES" down
